---
title: "Helen_corrected"
output: html_document
date: "2024-03-17"
---

```{r load data, include=FALSE}
#load("/srv/scratch/berrylab/z5459891/AGRF_data/AGRF_NXGSQCAGRF23110166-1_22J25VLT3/helen_corrected.RData")
setwd("/srv/scratch/berrylab/z5459891/AGRF_data/AGRF_NXGSQCAGRF23110166-1_22J25VLT3")
samples <- list.files("rsem")
expr <- sapply(samples, function(sample){
  file <- paste0("rsem/",sample,"/",sample,".genes.results")
  quant <- read.csv(file, sep="\t", header=T)
  tpm <- setNames(quant$TPM, quant$gene_id)
  return(tpm)
})
```

```{r load library, include=FALSE}
library(tibble)
library(dplyr)
library(biomaRt)
library(ggplot2)
library(RColorBrewer)
library(ComplexHeatmap)
library(biomaRt)
library(data.table)
library(tidyr)
library(matrixStats)
library(ggplot2)
library(plyr)
```

```{r generate metadata}
metadata <- tibble(
  SampleName = c(
    "R1_D3_PRC2i","R1_D6_PRC2i","R2_D3_DMSO","R2_D3_PRC2i","R2_D9_DMSO"),
  Filename = c(
    "Replicate1_Day3_PRC2i",
    "Replicate1_Day6_PRC2i",
    "Replicate2_Day3_DMSO",
    "Replicate2_Day3_PRC2i",
    "Replicate2_Day9_DMSO"
  ),
  Replicate = c(
    "1","1","2","2","2"
  ),
  Treatment = c(
    "PRC2i","PRC2i","DMSO","PRC2i","Washout"
  ),
  Timepoint = c(
    "Day3","Day6","Day3","Day3","Day9"
  )
)
print(metadata)


```



```{r check expression, echo=FALSE}
# Identify constant or zero columns


ensembl <-
  useMart("ENSEMBL_MART_ENSEMBL", 
          host="https://grch37.ensembl.org",
          path="/biomart/martservice", 
          dataset = "hsapiens_gene_ensembl")
meta_genes <- getBM(attributes = c("ensembl_gene_id",
                                    "ensembl_gene_id_version",
                                     "hgnc_symbol",
                                     "description",
                                  "chromosome_name",
                                     "start_position",
                                     "entrezgene_id",
                                     "end_position",
                                    "strand"),
                      filters = "ensembl_gene_id_version",
                      values = rownames(expr),
                      mart = ensembl) %>%
    right_join(data.frame(ensembl_gene_id_version = rownames(expr)),
               by = "ensembl_gene_id_version") %>%
    distinct(ensembl_gene_id_version, .keep_all = TRUE)


```


```{r}
#input TPM and FPKM 
#TPM is normalized for sequencing depth and gene length, gene count comparisons within a sample or between samples 
#FPKM would be more appropriate for comparison between genes within a sample --> NOT recommended

#use TPM 
```



```{r check expression2, echo=FALSE}
expr <- expr[meta_genes$ensembl_gene_id_version,]
# expressed <- apply(expr, 1, function(row) all(row > 1))
# expr <- expr[which(expressed),]

```


```{r check expression3, echo=FALSE}
expr_df <- data.frame(expr)
expr_df <- as.data.frame(expr)
expr_df$ensembl_gene_id_version <- rownames(expr_df)
#expr_with_gene_id <- cbind(expr_df, meta_genes$ensembl_gene_id, meta_genes$hgnc_symbol)
metagene_subset <- meta_genes[meta_genes$ensembl_gene_id_version %in% rownames(expr_df), ]

expr_with_gene_id <- right_join(expr_df, 
                                metagene_subset %>% 
                                    dplyr::select(ensembl_gene_id_version, ensembl_gene_id,hgnc_symbol), 
                                by = "ensembl_gene_id_version")
rownames(expr_with_gene_id) <- expr_with_gene_id$ensembl_gene_id_version

```


```{r check expression4, echo=FALSE}
dim(expr)

avg_expr <- rowMeans(expr)

layout(matrix(1:2, nrow=1))
hist(avg_expr)
hist(log2(avg_expr + 1))
hist(log10(avg_expr +1 ))

```
```{r}

##what is the distribution of the z-score calculate
#take the matrix and melt to make a table 2 columns 1-sample 2- score value
#plot the zscore variation 
#first find the duplicates 
#subset fo

m1_melt <- reshape2::melt(expr_with_gene_id, id.vars="ensembl_gene_id")
m1_melt$value <- as.numeric(m1_melt$value)
m1_melt <- drop_na(m1_melt)
m1_melt$zscore <- ave(m1_melt$value, m1_melt$ensembl_gene_id, FUN=scale)

mu <- ddply(m1_melt, "variable", summarise, grp.mean=mean(zscore))

p<-ggplot(m1_melt, aes(x=zscore, color=variable)) +
  geom_density()+
  geom_vline(data=mu, aes(xintercept=grp.mean, color=variable),
             linetype="dashed")
p


```


```{r  1}
m2_melt<-drop_na(m1_melt)

#get the rows with the largest ranges 
heatmap_input <- pivot_wider(m2_melt[c("ensembl_gene_id","zscore","variable")], names_from = "variable",values_from = "zscore")
dim(heatmap_input)
#select for rows that have the largest range 
m1 <- as.matrix(heatmap_input[2:6])
#calculate the ranges 
#head(rowRanges(m1))
```


```{r}

#calculate the ranges 
head(rowRanges(m1))
#select the rows of interest that are the top 2000 genes that have the largest change
```
```{r 2, echo=FALSE}
hmap1 <- Heatmap(m1,# row (gene) parameters
      cluster_rows = TRUE,
      show_row_dend = TRUE,
      #row_title = 'Statistically significant genes',
      row_title_side = 'left',
      row_title_gp = gpar(fontsize = 12,  fontface = 'bold'),
      row_title_rot = 90,
      show_row_names = FALSE,
      row_names_gp = gpar(fontsize = 10, fontface = 'bold'),
      row_names_side = 'left',
      row_dend_width = unit(25,'mm'),)
  # genelabels1 <- rowAnnotation(
  #   Genes = anno_mark(
  #     at = seq(1, nrow(m1)),
  #     labels = rownames(m1),
  #     labels_gp = gpar(fontsize = 4),
  #     padding = 0.5))
draw(hmap1)
# draw(hmap1 + genelabels1)

```

